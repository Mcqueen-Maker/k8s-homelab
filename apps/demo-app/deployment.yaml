# Frontend Deployment - Nginx serving static content
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: demo-app
  labels:
    app: frontend
    app.kubernetes.io/name: demo-app
    app.kubernetes.io/component: frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "80"
    spec:
      containers:
        - name: nginx
          image: nginx:1.25-alpine
          ports:
            - containerPort: 80
              name: http
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "100m"
              memory: "128Mi"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 5
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: nginx.conf
            - name: html-content
              mountPath: /usr/share/nginx/html/index.html
              subPath: index.html
      volumes:
        - name: nginx-config
          configMap:
            name: frontend-config
        - name: html-content
          configMap:
            name: frontend-config

---
# Backend Deployment - Python Flask API
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: demo-app
  labels:
    app: backend
    app.kubernetes.io/name: demo-app
    app.kubernetes.io/component: backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "5000"
    spec:
      containers:
        - name: backend
          image: python:3.11-slim
          command: ["python", "-c"]
          args:
            - |
              from flask import Flask, jsonify
              import redis
              import os
              import socket

              app = Flask(__name__)

              @app.route('/api/health')
              def health():
                  redis_ok = False
                  try:
                      r = redis.Redis(
                          host=os.environ.get('REDIS_HOST', 'redis'),
                          port=int(os.environ.get('REDIS_PORT', 6379))
                      )
                      r.ping()
                      redis_ok = True
                      r.incr('visit_count')
                      visits = r.get('visit_count').decode()
                  except:
                      visits = 'N/A'
                  
                  return jsonify({
                      'status': 'healthy',
                      'hostname': socket.gethostname(),
                      'redis': redis_ok,
                      'visits': visits,
                      'app': os.environ.get('APP_NAME', 'Demo App')
                  })

              @app.route('/api/info')
              def info():
                  return jsonify({
                      'app': os.environ.get('APP_NAME'),
                      'env': os.environ.get('APP_ENV'),
                      'hostname': socket.gethostname()
                  })

              if __name__ == '__main__':
                  # Install dependencies
                  import subprocess
                  subprocess.run(['pip', 'install', 'flask', 'redis', '-q'])
                  app.run(host='0.0.0.0', port=5000)
          ports:
            - containerPort: 5000
              name: http
          envFrom:
            - configMapRef:
                name: app-config
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
          livenessProbe:
            httpGet:
              path: /api/health
              port: 5000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/health
              port: 5000
            initialDelaySeconds: 30
            periodSeconds: 5

---
# Redis Deployment - In-memory cache/database
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: demo-app
  labels:
    app: redis
    app.kubernetes.io/name: demo-app
    app.kubernetes.io/component: database
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          ports:
            - containerPort: 6379
              name: redis
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "100m"
              memory: "128Mi"
          livenessProbe:
            exec:
              command:
                - redis-cli
                - ping
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            exec:
              command:
                - redis-cli
                - ping
            initialDelaySeconds: 5
            periodSeconds: 5

